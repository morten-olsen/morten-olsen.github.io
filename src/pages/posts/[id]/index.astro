---
import Html from '~/components/page/Html.astro';
import type { GetStaticPaths } from "astro";
import { render } from "astro:content";
import {Â data } from '~/data/data'
import { Picture } from 'astro:assets';
import AbsoluteTime from '~/components/base/time/AbsoluteTime.astro';

export const getStaticPaths = (async () => {
  const posts = await data.posts.getPublished();
  return posts.map((post, index) => ({
    params: { id: post.id },
    props: {
      prevPost: posts[index + 1] || null,
      nextPost: posts[index - 1] || null,
    }
  }));
}) satisfies GetStaticPaths;

const { prevPost, nextPost } = Astro.props;
const post = await data.posts.get(Astro.params.id);
const { Content, headings } = await render(post);
const tocHeadings = headings.filter(h => h.depth === 2);
const hasToC = tocHeadings.length >= 3;
---

<Html
  title={post.data.title}
  description={post.data.description}
  jsonLd={post.jsonLd}
  image={`/posts/${post.id}/share.png`}
  type="article"
  publishedTime={post.data.pubDate}
  modifiedTime={post.data.updatedDate}
  author={data.profile.name}
  tags={post.data.tags}
>

  <article>
    <div class="hero-image anim-hero" data-parallax-bg>
      <Picture
        loading='eager'
        class='img'
        fetchpriority="high"
        src={post.data.heroImage}
        widths={[320, 640, 1024, 1400]}
        formats={['avif', 'webp', 'png']}
        alt='Cover image'
      />
    </div>
    <div class="article-container">
      <header>
        <h1>
          {post.data.title.split(' ').map((word, i) => <span style={`--delay: ${i * 0.05}s`}>{word}</span>)}
        </h1>
        <p class="description anim-fade">{post.data.description}</p>
        <div class="meta anim-fade">
          <a href='/' class="author">By {data.profile.name}</a>
          <span class="meta-item">
            <AbsoluteTime datetime={post.data.pubDate} format={{ month: "long", day: "numeric", year: "numeric" }} />
          </span>
          <span class="meta-item">{post.readingTime} min read</span>
        </div>
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="tags anim-fade">
            {post.data.tags.map((tag, i) => (
              <span class="tag" style={`--tag-delay: ${i * 0.05}s`}>{tag}</span>
            ))}
          </div>
        )}
      </header>

      <div class="content-wrapper">
        {hasToC && (
          <aside class="toc">
            <h4>Contents</h4>
            <ul>
              {tocHeadings.map(h => (
                <li><a href={`#${h.slug}`}>{h.text}</a></li>
              ))}
            </ul>
          </aside>
        )}
        <div class='content anim-fade-up'>
          <Content />
        </div>
      </div>

      <!-- Previous/Next navigation -->
      <nav class="post-nav">
        {prevPost ? (
          <a href={`/posts/${prevPost.id}`} class="nav-link nav-prev">
            <span class="nav-label">Previous</span>
            <span class="nav-title">{prevPost.data.title}</span>
          </a>
        ) : <div />}
        {nextPost ? (
          <a href={`/posts/${nextPost.id}`} class="nav-link nav-next">
            <span class="nav-label">Next</span>
            <span class="nav-title">{nextPost.data.title}</span>
          </a>
        ) : <div />}
      </nav>
    </div>
  </article>
</Html>

<style>
  h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-family-heading);
    font-weight: 700;
    line-height: 1.2;
    margin: 0;
  }

  article {
    font-family: var(--font-family);
    color: var(--color);
    background-color: var(--card-bg);
    font-size: 1.05rem;
    line-height: 1.7;
  }

  /* Hero image - full width banner */
  .hero-image {
    width: 100%;
    height: 50vh;
    min-height: 400px;
    overflow: hidden;
    border-bottom: var(--border-width) solid var(--border-color);
    background: var(--accent-tertiary);
    position: relative;

    img {
      display: block;
      width: 100%;
      height: 120%;
      object-fit: cover;
      object-position: center;
      transform: scale(1.1);
    }
  }

  .article-container {
    max-width: 750px;
    margin: 0 auto;
    padding: 0 var(--space-xl);
  }

  header {
    padding: calc(var(--gap) * 3) 0;
    border-bottom: var(--border-width) solid var(--border-color);
    margin-bottom: calc(var(--gap) * 2);
  }

  h1 {
    display: flex;
    flex-wrap: wrap;
    font-family: var(--font-family-display);
    font-size: 3.2rem;
    line-height: 1;
    color: var(--on-accent);
    text-transform: uppercase;
    font-weight: 400;
    gap: 0.4rem;
    margin-bottom: var(--gap);

    span {
      display: inline-block;
      background: var(--accent-primary);
      padding: 0.4rem 0.8rem;
      border: var(--border-width) solid var(--on-accent);
      box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--on-accent);

      &:nth-child(3n+2) {
        background: var(--accent-tertiary);
      }

      &:nth-child(3n) {
        background: var(--accent-lime);
      }
    }
  }

  .description {
    font-size: 1.2rem;
    line-height: 1.6;
    color: var(--color-text-light);
    margin-bottom: var(--gap);
    max-width: 600px;
  }

  .meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: var(--gap);
  }

  .meta-item {
    font-size: 0.9rem;
    color: var(--color-text-light);
  }

  .author {
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    padding: 0.4rem 0.8rem;
    background: var(--c-bg-em);
    border: 2px solid var(--border-color);
    display: inline-block;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
    padding: 0.3rem 0.7rem;
    background: var(--accent-lavender);
    border: 2px solid var(--on-accent);
    color: var(--on-accent);
    animation: fadeIn 0.3s ease-out both;
    animation-delay: calc(0.4s + var(--tag-delay, 0s));

    &:nth-child(3n+2) {
      background: var(--accent-secondary);
    }
    &:nth-child(3n) {
      background: var(--accent-lime);
    }
  }

  .content {
    padding-bottom: calc(var(--space-xl) * 3);

    img {
      max-width: 100%;
      height: auto;
      margin-bottom: var(--space-lg);
      border: var(--border-width) solid var(--border-color);
      box-shadow: var(--shadow-brutal);
    }

    p {
      margin-bottom: var(--space-lg);
      line-height: 1.8;
    }

    p:first-of-type {
      &:first-letter {
        font-size: 4.5rem;
        border: var(--border-width) solid var(--on-accent);
        background: var(--accent-primary);
        float: left;
        padding: 0.2rem var(--space-md);
        margin-right: 1rem;
        margin-bottom: 0.5rem;
        line-height: 1;
        box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--on-accent);
        color: var(--on-accent);
      }
    }

    h2 {
      font-family: var(--font-family-display);
      font-size: 1.4rem;
      font-weight: 400;
      margin-bottom: var(--space-md);
      margin-top: var(--space-xl);
      text-transform: uppercase;
      background: var(--accent-secondary);
      padding: 0.5rem 1rem;
      border: var(--border-width) solid var(--on-accent);
      box-shadow: var(--shadow-brutal);
      display: inline-block;
      color: var(--on-accent);
    }

    h3 {
      font-family: var(--font-family-display);
      font-size: 1.1rem;
      text-transform: uppercase;
      font-weight: 400;
      margin-bottom: 1rem;
      margin-top: var(--space-lg);
      padding-left: var(--space-md);
      border-left: var(--border-width) solid var(--border-color);
    }

    strong {
      background: var(--accent-primary);
      padding: 0 4px;
      border: 2px solid var(--on-accent);
      font-weight: 700;
      color: var(--on-accent);
    }

    em {
      font-style: italic;
    }

    ul, ol {
      margin-bottom: var(--space-lg);
      padding-left: var(--space-lg);
    }

    li {
      list-style-type: square;
      margin-left: 1rem;
      padding-bottom: var(--space-sm);
      line-height: 1.6;

      &::marker {
        color: var(--accent-secondary);
        font-size: 1.2em;
      }
    }

    pre {
      max-width: 100%;
      overflow-x: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      padding: var(--space-lg);
      border: var(--border-width) solid var(--border-color);
      box-shadow: var(--shadow-brutal-lg);
      background: #1a1a1a;
      color: #f0f0f0;
      margin-bottom: var(--space-lg);
    }

    code:not(pre code) {
      background: var(--c-bg-em);
      padding: 2px 6px;
      border: 2px solid var(--border-color);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9em;
    }

    blockquote {
      margin: var(--space-xl) 0;
      background: var(--accent-lavender);
      padding: var(--space-lg);
      border: var(--border-width) solid var(--on-accent);
      box-shadow: var(--shadow-brutal-lg);
      font-style: italic;
      font-size: 1.1rem;
      position: relative;
      color: var(--on-accent);

      &::before {
        content: '"';
        font-size: 4rem;
        font-weight: 700;
        position: absolute;
        top: -0.5rem;
        left: 0.5rem;
        opacity: 0.3;
        line-height: 1;
      }

      p:last-child {
        margin-bottom: 0;
      }
    }

    a {
      color: var(--t-fg);
      text-decoration: underline;
      text-decoration-thickness: 3px;
      text-decoration-color: var(--accent-secondary);
      text-underline-offset: 3px;
      transition: all 0.1s ease;

      &:hover {
        background: var(--accent-secondary);
      }
    }
  }

  @media (max-width: 768px) {
    .hero-image {
      height: 35vh;
      min-height: 250px;
    }

    .article-container {
      padding: 0 var(--space-lg);
    }

    header {
      padding: calc(var(--gap) * 2) 0;
    }

    h1 {
      font-size: 2rem;
    }

    .content p:first-of-type:first-letter {
      font-size: 3.5rem;
    }
  }

  /* Entry animations */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(1.05);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes wordIn {
    from {
      opacity: 0;
      transform: translateY(20px) rotate(-2deg);
    }
    to {
      opacity: 1;
      transform: translateY(0) rotate(0);
    }
  }

  .anim-hero {
    animation: scaleIn 0.8s ease-out both;

    img {
      animation: fadeIn 1s ease-out both;
    }
  }

  h1 span {
    animation: wordIn 0.4s ease-out both;
    animation-delay: var(--delay, 0s);
  }

  .anim-fade {
    animation: fadeIn 0.5s ease-out 0.3s both;
  }

  .anim-fade-up {
    animation: fadeInUp 0.6s ease-out 0.4s both;
  }

  /* Print styles */
  @media print {
    .hero-image {
      display: none;
    }

    .article-container {
      max-width: none;
      padding: 0;
    }

    header {
      border-bottom: 2px solid #000;
      padding: 0 0 1rem;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 1.8rem;

      span {
        background: none;
        border: none;
        box-shadow: none;
        padding: 0;
      }
    }

    .author {
      background: none;
      border: none;
      padding: 0;
    }

    .content {
      padding-bottom: 0;

      h2 {
        background: none;
        border: none;
        box-shadow: none;
        padding: 0;
        border-bottom: 2px solid #000;
        display: block;
      }

      pre {
        border: 1px solid #ccc;
        box-shadow: none;
        background: #f5f5f5;
        color: #000;
      }

      blockquote {
        box-shadow: none;
        background: #f5f5f5;
        border: none;
        border-left: 4px solid #000;
      }

      img {
        box-shadow: none;
      }

      strong {
        background: none;
        border: none;
      }

      p:first-of-type:first-letter {
        background: none;
        box-shadow: none;
        border: none;
      }
    }
  }


  /* Content wrapper */
  .content-wrapper {
    display: flex;
    gap: calc(var(--gap) * 2);
  }

  .content {
    flex: 1;
    min-width: 0;
  }

  /* Table of Contents */
  .toc {
    display: none;
  }

  @media (min-width: 1100px) {
    .article-container {
      max-width: calc(750px + 220px + var(--gap) * 2);
    }

    header,
    .post-nav {
      max-width: 750px;
    }

    .content {
      max-width: 750px;
    }

    .toc {
      display: block;
      flex: 0 0 200px;
      align-self: flex-start;
      position: sticky;
      top: calc(var(--gap) * 2);
      order: 2;
    }

    .content {
      order: 1;
    }

    .toc h4 {
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.05em;
      margin-bottom: calc(var(--gap) * 0.75);
      padding: 0.3rem 0.6rem;
      background: var(--accent-tertiary);
      border: 2px solid var(--on-accent);
      display: inline-block;
      color: var(--on-accent);
    }

    .toc ul {
      list-style: none;
      padding: 0;
      margin: 0;
      border-left: 3px solid var(--border-color);
    }

    .toc li {
      margin: 0;
      padding-left: 0;
      list-style-type: none;

      &::marker {
        content: none;
      }
    }

    .toc a {
      font-size: 0.8rem;
      color: var(--color-text-light);
      text-decoration: none;
      transition: all 0.1s ease;
      display: block;
      padding: 0.4rem 0.75rem;
      margin-left: -3px;
      border-left: 3px solid transparent;

      &:hover {
        color: var(--t-fg);
        background: var(--c-bg-em);
      }

      &.active {
        color: var(--on-accent);
        font-weight: 600;
        border-left-color: var(--accent-primary);
        background: var(--accent-primary);
      }
    }
  }

  /* Previous/Next navigation */
  .post-nav {
    display: flex;
    justify-content: space-between;
    gap: var(--gap);
    padding: calc(var(--gap) * 2) 0;
    border-top: 1px solid var(--border-color);
    margin-top: calc(var(--gap) * 2);
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    text-decoration: none;
    max-width: 45%;
    transition: all 0.15s ease;

    &:hover .nav-title {
      text-decoration-color: var(--accent-primary);
    }
  }

  .nav-prev {
    text-align: left;
  }

  .nav-next {
    text-align: right;
    margin-left: auto;
  }

  .nav-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: 600;
    color: var(--color-text-light);
    letter-spacing: 0.05em;
  }

  .nav-title {
    font-size: 0.9rem;
    font-weight: 500;
    line-height: 1.4;
    text-decoration: underline;
    text-decoration-color: var(--border-color);
    text-underline-offset: 3px;
    text-decoration-thickness: 2px;
    transition: text-decoration-color 0.15s ease;
  }

  /* Hero parallax */
  [data-parallax-bg] img {
    transition: transform 0.1s ease-out;
  }

  @media (max-width: 768px) {
    .post-nav {
      flex-direction: column;
    }

    .nav-link {
      max-width: 100%;
    }

    .nav-next {
      text-align: left;
    }

    .description {
      font-size: 1.05rem;
    }
  }
</style>

<script>
  // Hero image parallax
  const heroBg = document.querySelector('[data-parallax-bg] img') as HTMLElement | null;

  function updateParallax() {
    const scrollY = window.scrollY;
    if (heroBg && scrollY < window.innerHeight) {
      heroBg.style.transform = `translateY(${scrollY * 0.3}px) scale(1.1)`;
    }
  }

  window.addEventListener('scroll', updateParallax, { passive: true });
  updateParallax();

  // ToC active section highlighting
  const tocLinks = document.querySelectorAll('.toc a');
  const headings = document.querySelectorAll('.content h2[id]');

  if (tocLinks.length > 0 && headings.length > 0) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.getAttribute('id');
            tocLinks.forEach((link) => {
              link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
            });
          }
        });
      },
      {
        rootMargin: '-80px 0px -70% 0px',
        threshold: 0,
      }
    );

    headings.forEach((heading) => observer.observe(heading));
  }
</script>

